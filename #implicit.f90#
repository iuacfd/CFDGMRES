module implicit

contains

  subroutine CallAll
    use PointNeighbor
    use MeshData, only: inpoel, nelem, npoin
    implicit none
    call getEsup(inpoel,nelem,npoin)
    call getLocal
  end subroutine CallAll


  subroutine getLocal
    use PointNeighbor, only: esup2, esup1
    use MeshData, only: inpoel, nelem, npoin
    implicit none
    integer, dimension(:), allocatable :: lnum1
    integer ipoin, ielem, iesup, jpoin, i


    !Armar vector con las posiciones locales en un elemento del nodo i
    allocate(lnum1(esup2(npoin+1)))
    do ipoin=1,npoin
       do iesup=esup2(ipoin)+1, esup2(ipoin+1)
          ielem=esup1(iesup)
          do i=1,3
             jpoin=inpoel(i,ielem)
             if(jpoin==ipoin) then
                lnum1(iesup)=i
             end if
          enddo
       end do
    end do

    !do i=1, esup2(npoin+1)
    !   print*,esup1(i),lnum1(i)
    !end do
    !stop
  end subroutine getLocal

  subroutine rhsvector(rhs_tmp,ipoi1,ipoi2,ipoi3)
    use PointNeighbor, only: esup2,esup3,esup4
    !PARA PASAR DE RHS LOCAL A VECTOR DE RHS GLOBAL
    implicit none
    real*8, dimension(4,3) :: rhs_tmp
    do i=1,4
       esup3(esup2(ipoi1)+esup4(ipoi1)+esup2(npoin+1)*(i-1))=rhs_tmp(i,ipoi1)
       esup4(ipoi1)=esup4(ipoi1)+1     
       esup3(esup2(ipoi2)+esup4(ipoi2)+esup2(npoin+1)*(i-1))=rhs_tmp(i,ipoi2)
       esup4(ipoi2)=esup4(ipoi2)+1   
       esup3(esup2(ipoi3)+esup4(ipoi3)+esup2(npoin+1)*(i-1))=rhs_tmp(i,ipoi3)
       esup4(ipoi3)=esup4(ipoi3)+1   
    end do
  end subroutine rhsvector


  subroutine intimpli

    use MeshData, only: nelem, npoin     
    integer*4, parameter :: n = npoin, im = 45 !size of krylov subspace
    real(8) eps,droptol 
    integer(4) maxits,iout,lfil,droptol,iwk

    eps=1.D-8
    maxits=100	
    iout=0
    lfil=25
    droptol=0.d0
    iwk=n*5

    call ilut(n,aa,ja,ia,lfil,droptol,alu,jlu,ju,iwk,w,jw,ierr)
    if (ierr.ne.0) print*, "PROBLEMA DE ILUT:" ierr
    call pgmres(n, im, rhs, sol, vv, eps, maxits, iout, aa, ja, ia, alu, jlu, ju, ierr)
    if (ierr.ne.0) print*, "PROBLEMA DE GMRES:" ierr

  end subroutine intimpli


  end module implicit
